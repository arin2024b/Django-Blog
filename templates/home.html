{% extends "base.html" %}


{% block content %}

{% load static %}

{% for post in featured_posts %}
{% if forloop.first %} <!--if condition lagano hoise jate repeate na hoy home.html a -->
<div class="jumbotron p-3 p-md-5 text-white rounded bg-dark"
  style="background-image: url({{post.featured_image.url}});background-blend-mode: overlay;background-size:cover;">
  <!--image fetch krar jnno last a .url dite hbe-->
  <div class="col-md-8 px-0">
    <h1 class="display-4 font-italic">{{post.title}}</h1>
    <p class="lead my-3">{{post.short_desc | truncatewords:15}}</p>
    <p class="lead mb-0"><a href="{% url 'blogs' post.slug %}" class="text-white font-weight-bold">Continue
        reading...</a></p>
  </div>
</div>
{% endif %}
{% endfor %}

<br>

<h1 class="text-uppercase text-info" style="letter-spacing: 2px;">Featured Post:</h1>
<div class="row mb-2">
  {% for post in featured_posts %}
  {% if not forloop.first %}
  <div class="col-md-6">
    <div class="card border-0">
      <div class="card-body">
        <h3><a href="{% url 'blogs' post.slug %}" class="text-success">{{post.title}}</a></h3>
        <small class="mb-1 text-muted" style="color:tomato !important;">{{post.created_at | timesince}} ago <--
            {{post.author}}</small>
            <!-- created_at er por | timesince use krle kto hour,kto minutes age create kra hoise oita show krbe-->
            <p class="card-text m-auto">{{post.short_desc | truncatewords:25}}</p>
            <!--it will keep first 30 words.. truncatechars use krle otogula character nito-->
      </div>
    </div> <br>
  </div>
  {% endif %}
  {% endfor %}
</div>

<br>

<h1 class="text-uppercase text-info" style="letter-spacing: 2px;">Recent Articles:</h1>
<main role="main" class="container p-0">
  <div class="row">
    <div class="col-md-8 blog-main">
      {% for pst in posts %}
      <div class="card border-0">
        <div class="card-body">
          <h3><a href="{% url 'blogs' pst.slug %}" class="text-dark">{{pst.title}}</a></h3>
          <small class="mb-1 text-muted" style="color:tomato !important;">{{pst.created_at | timesince}} ago <--
              {{pst.author}}</small>
              <!-- created_at er por | timesince use krle kto hour,kto minutes age create kra hoise oita show krbe-->
              <p class="card-text">{{pst.short_desc | truncatewords:25}}</p>
        </div>
      </div> <br>
      {% endfor %}

      <div class="p-1">
        <div class="p-1 bg-secondary rounded">
          <h4 class="font-italic bg-dark text-info rounded" style='opacity:0.869'><b>For Entertainment</b> (<i>Groove to
              the vibes and let the melodies spark your soul..!<b>üé∂</b></i>):-- </h4>
          <table style="border: 0;" cellspacing="10" cellpadding="0">
            {% for i in videos %}
            <tr>
              <td class="p-2">
                <div class="video-container bg-dark  border border-info border-3 rounded p-2 m-auto">
                  <header style="color:bisque !important;"><b>{{i.title}}</b>
                    <p class='text-info'>Uploaded: {{i.uploaded_at|date:'M d, Y'}}</p>
                  </header>
                  <video class='bg-secondary rounded' width="100%" height="auto" controls style="margin-bottom: 10px;"
                    data-video-id="{{ i.id }}">
                    <source src="{{i.video_file.url}}" type="video/mp4"> <!--jehetu src tai sese .url dite hbe-->
                    Your Browser Doesn't Support The Video Tag
                  </video>

                  <!-- View Count Display -->
                  <div class="view-count-section mb-2">
                    <span class="badge bg-black border border-danger border-1 text-info">ü§®Ô∏è <span class="view-count text-danger" id="view-count-{{ i.id }}">
                      {{ i.views }}</span> views</span>
                  </div>

                  <!-- Reaction and Comment Section -->
                  <div class="interaction-section" data-video-id="{{ i.id }}">
                    <!-- Reaction buttons -->
                    <div class="reaction-buttons d-flex align-items-center mb-2">
                      {% if user.is_authenticated %}
                      <button class="react-btn btn btn-info btn-sm me-2 love-btn border border-warning border-1" data-reaction="love">
                        ‚ù§Ô∏è <span class="love-count text-info">{{ i.love_count }}</span>
                      </button>
                      <button class="react-btn btn btn-danger btn-sm me-3 dislike-btn border border-warning border-1" data-reaction="dislike">
                        ü•¥ <span class="dislike-count text-info">{{ i.dislike_count }}</span>
                      </button>
                      <button class="comment-toggle-btn btn btn-secondary btn-sm me-2 border border-danger border-1" data-video-id="{{ i.id }}">
                        üí¨ <span class="comment-count text-info">0</span> Comments
                      </button>
                      {% else %}
                      <span class="reaction-display me-3 text-info">
                        ‚ù§Ô∏è {{ i.love_count }} ü•¥ {{ i.dislike_count }}
                      </span>
                      <button class="comment-toggle-btn btn btn-secondary btn-sm me-2 text-warning"
                        data-video-id="{{ i.id }}">
                        üí¨ <span class="comment-count text-warning">0</span> Comments
                      </button>
                      <a href="{% url 'login' %}"
                        class='btn btn-info btn-sm text-black border border-warning border-2'><b>Login to react & cmnt</b></a>
                      {% endif %}
                    </div>

                    <!-- Comment Input (only for authenticated users) -->
                    {% if user.is_authenticated %}
                    <div class="comment-input-section mb-2" style="display: none;" id="comment-input-{{ i.id }}">
                      <div class="input-group">
                        <input type="text" class="form-control comment-input bg-secondary text-warning me-2"
                          placeholder="Write a comment..." data-video-id="{{ i.id }}">
                        <button class="btn btn-warning text-black submit-comment-btn rounded"
                          data-video-id="{{ i.id }}">Post</button>
                      </div>
                    </div>
                    {% endif %}

                    <!-- Comments Display -->
                    <div class="comments-section" style="display: none;" id="comments-{{ i.id }}">
                      <div class="comments-container bg-black p-2 rounded border border-warning border-1"
                        style="max-height: 200px; overflow-y: auto;">
                        <div class="comments-list text-white" id="comments-list-{{ i.id }}">
                          <!-- Comments will be loaded here -->
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </table>
        </div>
      </div>
    </div> <br>


    {% for i in about %}
    <aside class="col-md-4 blog-sidebar">
      <div class="p-3 mb-3 bg-light rounded">
        <h4 class="font-italic" style="color: brown !important;">About</h4>
        <p class="mb-0 text-dark">Arin Ahmed,<em>a dedicated Computer Science and Technology (CST) student</em>
          {{i.about}}</p>
      </div>
      {% endfor %}

      {% if social_links %}
      <div class="p-3">
        <h4 class="font-italic">Follow Me On:</h4>
        <ol class="list-unstyled">
          {% for lnk in social_links %}
          <li><a href="{{lnk.link}}" target="_blank">{{lnk.platform}}</a></li>
          {% endfor %}
        </ol>
      </div>
      {% endif %}
    </aside>
  </div>

</main>

{% csrf_token %}
<script>
  // Add this to make user authentication status available to JS
  const userAuthenticated = document.body.getAttribute('data-user-authenticated') === 'true';
  const rawUserId = document.body.dataset.userId;
  const currentUserId = rawUserId === "null" ? null : parseInt(rawUserId);


  document.addEventListener('DOMContentLoaded', function () {
    const videos = document.querySelectorAll('video');

    videos.forEach(video => {
      let viewCounted = false; // Track if view has been counted for this video

      video.addEventListener('play', function () {
        // Pause other videos
        videos.forEach(v => {
          if (v !== video) {
            v.pause();
          }
        });

        // Increment view count (only once per page load and only for logged-in users)

        if (userAuthenticated) {
          if (!viewCounted) {
            const videoId = this.dataset.videoId;

            fetch(`/view/${videoId}/`, {
              method: 'POST',
              headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
              }
            })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  const viewCountElement = document.getElementById(`view-count-${videoId}`);
                  if (viewCountElement) {
                    viewCountElement.textContent = data.views;
                  }
                }
              })
              .catch(error => console.error('Error:', error));

            viewCounted = true;
          }
        }
      });
    });
  });

  document.addEventListener('DOMContentLoaded', function () {
    // Reaction functionality
    const reactButtons = document.querySelectorAll('.react-btn');

    reactButtons.forEach(button => {
      button.addEventListener('click', function () {
        const videoId = this.closest('.interaction-section').dataset.videoId;
        const reaction = this.dataset.reaction;

        fetch(`/react/${videoId}/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: `reaction=${reaction}`
        })
          .then(response => response.json())
          .then(data => {
            document.querySelector(`[data-video-id="${videoId}"] .love-count`).textContent = data.love_count;
            document.querySelector(`[data-video-id="${videoId}"] .dislike-count`).textContent = data.dislike_count;
          });
      });
    });

    // Comment toggle functionality
    const commentToggleBtns = document.querySelectorAll('.comment-toggle-btn');

    commentToggleBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        const videoId = this.dataset.videoId;
        const commentsSection = document.getElementById(`comments-${videoId}`);
        const commentInputSection = document.getElementById(`comment-input-${videoId}`);

        if (commentsSection.style.display === 'none') {
          // Show comments and load them
          commentsSection.style.display = 'block';
          if (commentInputSection) {
            commentInputSection.style.display = 'block';
          }
          loadComments(videoId);
        } else {
          // Hide comments
          commentsSection.style.display = 'none';
          if (commentInputSection) {
            commentInputSection.style.display = 'none';
          }
        }
      });
    });

    // Submit comment functionality
    const submitCommentBtns = document.querySelectorAll('.submit-comment-btn');

    submitCommentBtns.forEach(btn => {
      btn.addEventListener('click', function () {
        const videoId = this.dataset.videoId;
        const commentInput = document.querySelector(`input[data-video-id="${videoId}"]`);
        const commentText = commentInput.value.trim();

        if (commentText) {
          fetch(`/comment/${videoId}/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `comment=${encodeURIComponent(commentText)}`
          })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                commentInput.value = '';
                loadComments(videoId);
              }
            });
        }
      });
    });

    // Handle Enter key in comment input
    const commentInputs = document.querySelectorAll('.comment-input');

    commentInputs.forEach(input => {
      input.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          const videoId = this.dataset.videoId;
          const submitBtn = document.querySelector(`button[data-video-id="${videoId}"].submit-comment-btn`);
          submitBtn.click();
        }
      });
    });

    // Function to delete a comment
    function deleteComment(commentId, videoId) {
      if (confirm('Are you sure you want to delete this comment?')) {
        fetch(`/delete-comment/${commentId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Reload comments to update the list
            loadComments(videoId);
          } else {
            alert(data.error || 'Failed to delete comment');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while deleting the comment');
        });
      }
    }

    // Function to load comments
    function loadComments(videoId) {
      fetch(`/comments/${videoId}/`)
        .then(response => response.json())
        .then(data => {
          const commentsList = document.getElementById(`comments-list-${videoId}`);
          const commentCount = document.querySelector(`[data-video-id="${videoId}"] .comment-count`);

          commentCount.textContent = data.count;

          if (data.comments.length === 0) {
            commentsList.innerHTML = '<p class="text-danger text-center">No comments yet. Be the first to comment!</p>';
          } else {
            commentsList.innerHTML = data.comments.map(comment => {
              const deleteButton = userAuthenticated && currentUserId === comment.user_id 
                ? `<button class="btn btn-sm btn-outline-danger ms-2 delete-comment-btn" data-comment-id="${comment.id}" title="Delete comment">üóëÔ∏è</button>` 
                : '';
              
              return `
                    <div class="comment-item border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong class="text-warning">${comment.username}</strong>
                                <small class="text-info ms-2">${comment.created_at}</small>
                            </div>
                            ${deleteButton}
                        </div>
                        <p class="mb-0">${comment.comment}</p>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for delete buttons
            const deleteButtons = commentsList.querySelectorAll('.delete-comment-btn');
            deleteButtons.forEach(btn => {
              btn.addEventListener('click', function() {
                const commentId = this.dataset.commentId;
                deleteComment(commentId, videoId);
              });
            });
          }
        });
    }

    // Load initial comment counts
    commentToggleBtns.forEach(btn => {
      const videoId = btn.dataset.videoId;
      fetch(`/comments/${videoId}/`)
        .then(response => response.json())
        .then(data => {
          const commentCount = document.querySelector(`[data-video-id="${videoId}"] .comment-count`);
          commentCount.textContent = data.count;
        });
    });
  });
</script>
{% endblock %}